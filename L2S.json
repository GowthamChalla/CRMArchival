{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "WebSiteName": {
      "type": "string",
      "defaultValue": "l2sUATWebsite"
    },
    "AppServicePlan": {
      "type": "string",
      "defaultValue": "l2suatappserviceplan",
      "metadata": { "description": "Enter the name you wish to give to the App Service Plan, Do not enter the name that already exists." }
    },
    "KeyVaultName": {
      "type": "string",
      "defaultValue": "l2suatkeyvault",
      "metadata": { "description": "Enter the name you wish to give to the keyvalut, Do not enter the name that already exists." }
    },
    "SqlServerName": {
      "type": "string",
      "defaultValue": "l2suatsqlserver",
      "metadata": { "description": "Enter the name you wish to give to the SqlServer, Do not enter the name that already exists." }
    },
    "databaseName": {
      "type": "string",
      "defaultValue": "sample"
    },
    "WebAPIObjectId": {
      "type": "string",
      "defaultValue": "a1a8ed7a-b2da-47a4-83eb-a4d67483d2f2",
      "metadata": { "description": "Enter the object id generated by AAD Registration tool" }
    },
    "L2sdbConnectionString": {
      "type": "string",
      "defaultValue": "l2sdbconnectionstring",
      "metadata": { "description": "Enter the L2s db ConnectionString" }
    },
    "CosmicClientId": {
      "type": "string",
      "defaultValue": "5e66d153-0c9e-49ff-a368-ae757f3288d0",
      "metadata": { "description": "Enter the Keyvault Application id generated by AAD Registration tool" }
    },
    "CosmicClientSecret": {
      "type": "securestring",
      "defaultValue": "zODyxgbBytiKZ1b5uYBQp9ZvXeaQDseCzyLNI3pyEWY=",
      "metadata": { "description": "Enter the Keyvault secret generated by AAD Registration tool" }
    },
    "CosmicAPIResource": {
      "type": "string",
      "defaultValue": "https://cosmicwebapiuat.azurewebsites.net",
      "metadata": { "description": "Enter the Cosmic Org API Resource" }
    },
    "CosmicBaseUri": {
      "type": "string",
      "defaultValue": "https://cosmicwebapiuat.azurewebsites.net",
      "metadata": { "description": "Enter the Cosmic Base Uri" }
    },
    "MsxAPIUser": {
      "type": "string",
      "defaultValue": "qbek2svc@microsoft.com"
    },
    "MsxApiPasswd": {
      "type": "securestring",
      "defaultValue": "November0718@Updat"
    },
    "MsxAPIRoot": {
      "type": "string",
      "defaultValue": "https://msitsalesapi.azure-api.net/"
    },
    "MsxAzureApiKey": {
      "type": "string",
      "defaultValue": "d2c99409abb54b1b887e978b4a43fe31"
    },
    "MsxAudienceUri": {
      "type": "string",
      "defaultValue": "https://L2OAzureServices/"
    },
    "MsxDSClientID": {
      "type": "string",
      "defaultValue": "89944825-3061-4ebe-bd2d-ccc8a10b61cc"
    },
    "MsxRealmUri": {
      "type": "string",
      "defaultValue": "https://msitsalesds-us-prod.cloudapp.net/"
    },
    "skuName": {
      "type": "string",
      "allowedValues": [ "B1", "B2", "B3", "S1", "S2", "S3", "P1", "P2", "P3", "P4" ],
      "defaultValue": "S3",
      "minLength": 1,
      "metadata": { "description": "Describes plan's pricing tier and instance size. Check details at https://azure.microsoft.com/en-us/pricing/details/app-service/" }
    },
    "skuCapacity": {
      "type": "int",
      "minValue": 1,
      "defaultValue": 1,
      "metadata": { "description": "Describes plan's instance count" }
    },
    "sqlserveradministratorLogin": {
      "type": "string",
      "defaultValue": "v-chgowt@microsoft.com"
    },
    "sqlserveradministratorLoginPassword": {
      "type": "securestring",
      "defaultValue": "P@ssw0rd"
    }
  },
    "variables": {},
  "resources": [
    {
      "apiVersion": "2015-08-01",
      "name": "[parameters('WebSiteName')]",
      "type": "Microsoft.Web/sites",
      "location": "[resourceGroup().location]",
      "tags": {
        "[concat('hidden-related:', resourceGroup().id, '/providers/Microsoft.Web/serverfarms/', parameters('AppServicePlan'))]": "Resource",
        "displayName": "Website"
      },
      "properties": {
        "name": "[parameters('WebSiteName')]",
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('AppServicePlan'))]",
        "siteConfig": {
          "phpVersion": "off",
          "alwaysOn": true,
          "connectionStrings": [
            {
              "connectionString": "",
              "Name": "L2SEntities",
              "Type": 3
            }
          ],
          "appSettings": [
            {
              "value": "3.0.0.0",
              "name": "webpages:Version"
            },
            {
              "value": "false",
              "name": "webpages:Enabled"
            },
            {
              "value": "true",
              "name": "ClientValidationEnabled"
            },
            {
              "value": "true",
              "name": "UnobtrusiveJavaScriptEnabled"
            },
            {
              "value": "DEV",
              "name": "Environment"
            },
            {
              "value": "https://login.microsoftonline.com/",
              "name": "ida:AADInstance"
            },
            {
              "value": "microsoft.onmicrosoft.com",
              "name": "ida:Domain"
            },
            {
              "value": "72f988bf-86f1-41af-91ab-2d7cd011db47",
              "name": "ida:TenantId"
            },
            {
              "value": "d39fa10f-66d5-415b-807e-22d2d56c32d9",
              "name": "ida:ClientId"
            },
            {
              "value": "https://localhost:44378/",
              "name": "ida:PostLogoutRedirectUri"
            },
            {
              "value": "UZS/rMfLhPdhqZhyqBL6OsLhhGKHsmdaTA9ntoeNsJs=",
              "name": "ida:ClientSecret"
            },
            {
              "value": "de736e81-ed6c-e611-80dd-c4346bada154",
              "name": "japanId"
            },
            {
              "value": "2e002efe-e96c-e611-80dd-c4346bada154",
              "name": "locId"
            },
            {
              "value": "39ca4a4f-ed6c-e611-80dd-c4346bada154",
              "name": "locPSCId"
            },
            {
              "value": "273700a7-db6c-e611-80de-c4346bade470",
              "name": "aocId"
            },
            {
              "value": "74093734-ed6c-e611-80dd-c4346bada154",
              "name": "aocPSCId"
            },
            {
              "value": "b0c495d2-ed6c-e611-80dd-c4346bada154",
              "name": "otherCountryId"
            },
            {
              "value": "[parameters('CosmicClientId')]",
              "name": "keyvaultclientId"
            },
            {
              "value": "[parameters('CosmicClientSecret')]",
              "name": "keyvaultclientsecretId"
            },
            {
              "value": "[concat('https://',parameters('KeyVaultName'), '.vault.azure.net/')]",
              "name": "keyvaulturl"
            }




          ]
        }
      },
      "resources": [
        {
          "apiVersion": "2015-08-01",
          "type": "config",
          "name": "connectionstrings",
          "dependsOn": [
            "[resourceId('Microsoft.Web/Sites/', parameters('WebSiteName'))]"
          ],
          "properties": {
            "DefaultConnection": {
              "value": "[concat('Data Source=tcp:', reference(resourceId('Microsoft.Sql/servers/', parameters('SqlServerName'))).fullyQualifiedDomainName, ',1433;Initial Catalog=', parameters('databaseName'), ';User Id=', parameters('sqlserveradministratorLogin'), '@', parameters('SqlServerName'), ';Password=', parameters('sqlserveradministratorLoginPassword'), ';')]",
              "type": "SQLServer"
            },
            "L2SEntities": {
              "type": "Custom",
              "value": "empty"

            }
          }
        },
        {
          "type": "extensions",
          "name": "MSDeploy",
          "apiVersion": "2015-08-01",
          "location": "[resourceGroup().location]",
          "tags": { "displayName": "WebDeployforWebApp" },
          "properties": {
            "alwaysOn": true,
            "dbType": "None",
            "debugSetting": { "detailLevel": "requestContent, responseContent" },
            "packageUri": "https://github.com/GowthamChalla/CRMArchival/raw/master/CosmicL2sPackage.zip"
          },
          "dependsOn": [ "[concat('Microsoft.Web/sites/', parameters('webSiteName'))]" ]
        }
      ],
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverFarms/', parameters('AppServicePlan'))]"
      ]
    },
    {
      "name": "[parameters('SqlServerName')]",
      "type": "Microsoft.Sql/servers",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "SqlServer"
      },
      "apiVersion": "2014-04-01-preview",
      "properties": {
        "administratorLogin": "[parameters('sqlserveradministratorLogin')]",
        "administratorLoginPassword": "[parameters('sqlserveradministratorLoginPassword')]"
      }
    },   
    {
      "type": "Microsoft.Web/serverfarms",
      "sku": {
        "name": "[parameters('skuName')]",
        "capacity": "[parameters('skuCapacity')]"
      },
      "name": "[parameters('AppServicePlan')]",
      "apiVersion": "2015-08-01",
      "location": "[resourceGroup().location]",
      "tags": { "displayName": "HostingPlan" },
      "properties": {
        "name": "[parameters('AppServicePlan')]"
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "name": "[parameters('KeyVaultName')]",
      "apiVersion": "2015-06-01",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "KeyVault"
      },
      "properties": {
        "tenantId": "[subscription().tenantId]",
        "accessPolicies": [
          {
            "tenantId": "[subscription().tenantId]",
            "objectId": "[parameters('WebAPIObjectId')]",
            "permissions": {
              "keys": [ "all" ],
              "secrets": [ "all" ]
            }
          }
        ],
        "enabledForTemplateDeployment": true,
        "sku": {
          "name": "Standard",
          "family": "A"
        }
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "name": "[concat(parameters('KeyVaultName'), '/','L2sdbConnectionString')]",
      "apiVersion": "2015-06-01",
      "properties": {
        "contentType": "text/plain",
        "value": "[parameters('L2sdbConnectionString')]"
      },
      "dependsOn": [ "[concat('Microsoft.KeyVault/vaults/', parameters('KeyVaultName'))]" ]
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "name": "[concat(parameters('KeyVaultName'), '/','CosmicClientId')]",
      "apiVersion": "2015-06-01",
      "properties": {
        "contentType": "text/plain",
        "value": "[parameters('CosmicClientId')]"
      },
      "dependsOn": [ "[concat('Microsoft.KeyVault/vaults/', parameters('KeyVaultName'))]" ]
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "name": "[concat(parameters('KeyVaultName'), '/','CosmicClientSecret')]",
      "apiVersion": "2015-06-01",
      "properties": {
        "contentType": "text/plain",
        "value": "[parameters('CosmicClientSecret')]"
      },
      "dependsOn": [ "[concat('Microsoft.KeyVault/vaults/', parameters('KeyVaultName'))]" ]
    },
    {
      "apiVersion": "2015-06-01",
      "dependsOn": [ "[concat('Microsoft.KeyVault/vaults/', parameters('KeyVaultName'))]" ],
      "name": "[concat(parameters('KeyVaultName'), '/','CosmicAPIResource')]",
      "properties": {
        "contentType": "text/plain",
        "value": "[parameters('CosmicAPIResource')]"
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    },
    {
      "apiVersion": "2015-06-01",
      "dependsOn": [ "[concat('Microsoft.KeyVault/vaults/', parameters('KeyVaultName'))]" ],
      "name": "[concat(parameters('KeyVaultName'), '/','CosmicBaseUri')]",
      "properties": {
        "contentType": "text/plain",
        "value": "[parameters('CosmicBaseUri')]"
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    },
    {
      "apiVersion": "2015-06-01",
      "dependsOn": [ "[concat('Microsoft.KeyVault/vaults/', parameters('KeyVaultName'))]" ],
      "name": "[concat(parameters('KeyVaultName'), '/','MsxAPIUser')]",
      "properties": {
        "contentType": "text/plain",
        "value": "[parameters('MsxAPIUser')]"
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    },
    {
      "apiVersion": "2015-06-01",
      "dependsOn": [ "[concat('Microsoft.KeyVault/vaults/', parameters('KeyVaultName'))]" ],
      "name": "[concat(parameters('KeyVaultName'), '/','MsxApiPasswd')]",
      "properties": {
        "contentType": "text/plain",
        "value": "[parameters('MsxApiPasswd')]"
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    },
    {
      "apiVersion": "2015-06-01",
      "dependsOn": [ "[concat('Microsoft.KeyVault/vaults/', parameters('KeyVaultName'))]" ],
      "name": "[concat(parameters('KeyVaultName'), '/','MsxAPIRoot')]",
      "properties": {
        "contentType": "text/plain",
        "value": "[parameters('MsxAPIRoot')]"
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    },
    {
      "apiVersion": "2015-06-01",
      "dependsOn": [ "[concat('Microsoft.KeyVault/vaults/', parameters('KeyVaultName'))]" ],
      "name": "[concat(parameters('KeyVaultName'), '/','MsxAzureApiKey')]",
      "properties": {
        "contentType": "text/plain",
        "value": "[parameters('MsxAzureApiKey')]"
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    },
    {
      "apiVersion": "2015-06-01",
      "dependsOn": [ "[concat('Microsoft.KeyVault/vaults/', parameters('KeyVaultName'))]" ],
      "name": "[concat(parameters('KeyVaultName'), '/','MsxAudienceUri')]",
      "properties": {
        "contentType": "text/plain",
        "value": "[parameters('MsxAudienceUri')]"
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    },
    {
      "apiVersion": "2015-06-01",
      "dependsOn": [ "[concat('Microsoft.KeyVault/vaults/', parameters('KeyVaultName'))]" ],
      "name": "[concat(parameters('KeyVaultName'), '/','MsxDSClientID')]",
      "properties": {
        "contentType": "text/plain",
        "value": "[parameters('MsxDSClientID')]"
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    },
    {
      "apiVersion": "2015-06-01",
      "dependsOn": [ "[concat('Microsoft.KeyVault/vaults/', parameters('KeyVaultName'))]" ],
      "name": "[concat(parameters('KeyVaultName'), '/','MsxRealmUri')]",
      "properties": {
        "contentType": "text/plain",
        "value": "[parameters('MsxRealmUri')]"
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    }
  ]
  }